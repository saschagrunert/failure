---
version: 2
defaults: &defaults
  docker:
    - image: saschagrunert/build-haskell
workflows:
  version: 2
  pipeline:
    jobs:
      - build
      - doc
      - doc-publish:
          requires:
            - doc
          filters:
            branches:
              only: master
      - test
jobs:
  build:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: Version information
          command: stack --version
      - restore_cache:
          keys:
            - build-cache-{{ arch }}
      - run:
          name: Build all targets
          command: stack build
      - save_cache:
          key: build-cache-{{ arch }}
          paths:
            - .stack-work
            - /root/.stack
  doc:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          keys:
            - doc-cache-{{ arch }}
      - run:
          name: Build documentation
          command: stack haddock --no-haddock-deps
      - save_cache:
          key: doc-cache-{{ arch }}
          paths:
            - .stack-work
            - /root/.stack
      - persist_to_workspace:
          root: .
          paths:
            - .stack-work
  doc-publish:
    <<: *defaults
    steps:
      - add_ssh_keys:
          fingerprints:
            - 1f:6e:50:3c:dc:a6:f5:3c:1c:13:67:dd:b4:f9:da:99
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Setup git
          command: |
            git config --global user.email mail@saschagrunert.de
            git config --global user.name "CircleCI"
      - run:
          name: Deploy documentation
          command: |
            git fetch origin gh-pages
            git checkout -f gh-pages
            rm -rf doc
            mv .stack-work/install/x86_64-linux-tinfo6/lts-12.6/8.4.3/doc .
            git add .
            git diff-index --quiet HEAD || git commit -m 'Update documentation'
            git push -f origin gh-pages
  test:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          keys:
            - test-cache-{{ arch }}
      - run:
          name: Run tests
          command: stack test --coverage
      - run:
          name: Upload coverage report
          command: bash <(curl -s https://codecov.io/bash)
      - save_cache:
          key: test-cache-{{ arch }}
          paths:
            - .stack-work
            - /root/.stack
